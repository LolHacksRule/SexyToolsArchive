#include "Dialog.h"

static Dialog* gCurDialog = NULL;

#pragma warning(disable:4311)
#pragma warning(disable:4312)

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Dialog::Dialog()
{
	mHWND = NULL;
	mResult = 0;
	mDialogId = 0;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
INT_PTR WINAPI Dialog::StaticDialogProc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)
{
	Dialog *aDialog;
	if (msg==WM_INITDIALOG)
	{
		aDialog = gCurDialog;

		SetWindowLong(hwnd,GWL_USERDATA,(LONG)aDialog);
		if (aDialog != NULL)
			aDialog->mHWND = hwnd;

		INT_PTR aRet = aDialog->DialogProc(msg, wParam, lParam);
		aDialog->SetDataToWindows();

		return aRet;
	}

	aDialog = (Dialog*)GetWindowLong(hwnd,GWL_USERDATA);
	if(msg==WM_DESTROY)
		aDialog->GetDataFromWindows();

	if (aDialog != NULL)
		return aDialog->DialogProc(msg, wParam, lParam);
	else
		return FALSE;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
INT_PTR Dialog::DialogProc(UINT msg, WPARAM wParam, LPARAM lParam)
{
	return FALSE;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void Dialog::GetDataFromWindows()
{
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void Dialog::SetDataToWindows()
{
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
std::string Dialog::GetWindowText(HWND theHWND)
{
	char aBuf[4096];
	::GetWindowText(theHWND,aBuf,512);
	return aBuf;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
std::string Dialog::GetWindowTextItem(int theItem)
{
	return GetWindowText(GetDlgItem(theItem));
}


///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
HWND Dialog::GetDlgItem(int theItem)
{
	return ::GetDlgItem(mHWND, theItem);
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void Dialog::EndDialog(int theResult)
{
	mResult = theResult;
	::EndDialog(mHWND, theResult);
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
int Dialog::DoDialog(HWND theParent)
{
	mResult = 0;
	gCurDialog = this;
	DialogBox((HINSTANCE)GetModuleHandle(NULL), MAKEINTRESOURCE(mDialogId), theParent, StaticDialogProc); 

	return mResult;
}
